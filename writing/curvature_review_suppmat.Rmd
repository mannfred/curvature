---
title: "Supplementary material for Plant-pollinator specialization: Origin and measurement of curvature"
author:
date: ""
output: 
  word_document:
    fig_caption: yes
    reference_docx: curvature_review_reference.docx
  # html_document:
  #   number_sections: no
  #   theme: flatly
  # pdf_document:
  #   latex_engine: xelatex
bibliography: curvature_review.bib
csl: amnat.csl
link-citations: true #'yes' for html, 'true' for pdfs
linkcolor: blue
urlcolor: blue
citecolor: blue
---

&nbsp;
&nbsp;

Note: All data and scripts used in this study have been deposited
in the Dryad Digital Repository (https://doi.org/10.5061/dryad.8gtht76pm). 

&nbsp;
&nbsp;
&nbsp;
&nbsp;

#### Measuring _Epimedium_ flowers and defining developmental stages

We tested the utility of the proposed curvature metric by studying floral development in _Epimedium_ L. (Berberidaceae), a group of temperate, perennial herbs that inhabit montane ecosystems from North Africa to East Asia. _Epimedium_ is perhaps best recognized by having an elongated, curved nectar spur - a derived trait for pollination by bees [@stearn_2002, p. 23].  

&emsp;&emsp; Although widespread throughout _Epimedium_, the ecological function of nectar spur curvature is largely unstudied. Early work comparing sympatric short- and long-spurred species found evidence for pollinator partitioning in Japanese _Epimedium_ [@suzuki_1984]: long-horned bees with short proboscides (_Eucerea nipponensis_ Pérez) tend to visit _Epimedium trifoliolatobinatum_ Koidz (spur length 10-15 mm), while bumblebees with longer proboscides ( _Bombus diversus_ Smith) visit _Epimedium grandiflorum_ C.Morren (spur length 10-20 mm. While these pollinators are nectar foraging, Suzuki [-@suzuki_1984] also found that pollen-collecting bees (*Andrena* Fabricius and *Lassioglossum* Curtis) visit _Epimedium_ indiscriminately, potentially contributing to hybridization. Although numerous _Epimedium_ spp. exhibit strong floral curvature, the role of curvature, if any, on pollinator partitioning is unknown. 

&emsp;&emsp; Flower size of _E. koreanum_ and _E. violaceum_ ($n$=57) was measured daily from April 9 to May 2, 2019 at the UBC Botanical Garden (TableS2). Size was defined as the width between the apex of the two outer sepals on the major axis of the flower (aestivation is imbricate). Width was measured to the nearest 0.1 mm using an SPI Polymid Dial Caliper. By correlating changes in flower size to developmental progress, we were able to define 4 discrete size-stages present in both taxa (Table S3, Figures S7 and S8). 

&emsp;&emsp; In _E. violaceum_ the distance sepal distance was measured until the width of the inner sepals exceeded the width of the outer sepals ('G' Stage). From this point onwards, the inner sepal distance was measured. In _E. koreanum_, the inner sepals lack pigmentation and adhere closely to the petals, making them difficult to measure accurately. For this reason, the outer sepals were measured until they abscised ("T" stage). 

&emsp;&emsp; Changes in flower size were punctuated by developmental milestones (defined in Table S3). We tested for the validity of these developmental stages by fitting a linear mixed effects model using the R package `lmerTest` v.3.1-2 [@kuznetsova_2017]:

$$sepal \ \ size = \beta_0 + \beta_1*stage*taxon +U_i + \epsilon$$

Where $\beta_0$ is the intercept, $\beta_1$ is a coefficient, $U_i$ is the individual-specific random effect, and $\epsilon$ is the residual error (see: "1_epimedium_garden_data.R" in the Dryad repository). T-values were approximated using the Welch–Satterthwaite method in `lmerTest`. All data herein was organized and plotted using the R packages contained in the `tidyverse` [@wickham_2019]. 

&emsp;&emsp; We then tested for pairwise differences of estimated marginal means using the R package `emmeans` [@lenth_2018]. By correlating changes in flower size to developmental landmarks, we were able to define 4 discrete stages in _E. koreanum_ and _E. violaceum_ (Table S3, Figures S7 and S8). In the first stage ("C") the petals are shorter in length than the sepals that envelop them - the following stage begins when the petals overtake the surrounding sepals in length.  The 'G' stage includes continued growth of the bud until the petals begin to separate. At the 'T' stage nectar begins accumulating in the spurs. Anthesis takes place during the 'A' stage at which point the flower opening may increase in size and anthers dehisce. 

&emsp;&emsp; Flowering stage data was staggered because each flower developed independently. The data was also fragmented because some samples abscissed prematurely due to herbivory or weather. The flower development data was therefore a 'censored' dataset i.e. some subjects 'left the study' before reaching maturity. Although manually aligning the stage data is possible, for convenience we used a multiple sequence alignment protocol to automate the process. To do this, we ran the stage data through ClustalW implemented in the R package `msa` v.3.9 [@bodenhofer_2015] with a neutral (identity) substitution matrix (see: "2_seq_alignment_koreanum.R" and "2_seq_alignment_violaceum.R").  Gap opening was prohibited. By aligning phenological data within species, a consensus (mean) stage sequence was calculated and used to estimate flower age where observations were censored. 

&emsp;&emsp; We tested for differences in developmental time by fitting a linear mixed effects model using the R package `lmerTest`:

$$elpased \ \ days = \beta_0 + \beta_1*stage*taxon +U_i + \epsilon$$
Where $\beta_0$ is the intercept, $\beta_1$ is a coefficient, $U_i$ is the individual-specific random effect, and $\epsilon$ is the residual error (see: "4_plotting_stage_vs_time_and_size.R"). We then tested for pairwise differences of estimated marginal means using the R package `emmeans`. Results are presented in Table S4.



\newpage


#### Landmarking, morphometrics, and curve-fitting

Following the initial study of _Epimedium_ development, a separate set of flowers were sampled for shape analysis (Table S2). Samples were first preserved in 70% ethanol and later transferred to a glass slide. Preserved flowers were imaged in the dorsiventral view using a stereo microscope at 6.3x (Zeiss Stemi 508 with Axiocam 301). Scale bars were automatically generated by the Zeiss Zen software interfacing with the camera. Specimens that did not fit within the field of view were imaged in halves and the images joined using the Stitching Plugin in the Fiji distribution of ImageJ2 [@preibisch_2009; @rueden_2017]. To assign landmarks and semi-landmarks to the digitized specimens, we adhered to the following protocol:

1. Rotate the photographs so that the opening of the corolla tube is parallel to the y-axis. 
2. Build .tps file (a file listing all specimens) using _tpsUtil_ [@rohlf_2015]. This .tps file is used by _tpsdig_ for landmark assignment.
3. Landmark specimens from .tps file using tpsDig (steps 1 and 2 can also be done in the R packages `MomX` [@bonhomme_2014] and `geomorph` [@adams_2013]). Landmarks used to measure the dorsal arc were (A) the farthest point on the apex of the spur before the inflection point where either the spur diminishes to a tip (*E. violaceum*) or widens into a saccate reservoir (*E. koreanum*), and (B) the dorsal point at which the spur widens to become an attachment point for the petal to the stem. 13 semi-landmarks [sensu @webster_2010] were placed between them (15 points total). Landmarks used to measure the ventral are (C) the analogous point to (A) on the ventral side of the spur, and (D) the crease created by the sudden widening of the narrow spur into a wide opening for pollinators. 13 semi-landmarks were placed between them (15 points total). An additional landmark was place at the apex of the nectar spur, resulting in 31 total landmarks. The complete set of 31 landmarks was used for geometric morphometrics, whereas the dorsal and ventral 'sets' were used separately for curve-fitting and analysis of curvature.
4. Curve points were marked using the “pencil tool” in tpsDig, from landmarks (A) to (B). Following the placement of points, a curve is automatically drawn that connects them. We used the _Resample Curve_ function and selected to space the points evenly _by length_. We then manually adjusted the re-sampled points back onto the specimen and used the _Resample Curve_ function until all landmarks were aligned and evenly spaced. This does not usually need to be repeated more than twice.
5. We set the scale by navigating _Options_ -> _Image Tools_ and typing in desired length and units. We selected _Set scale_ and selected both ends of the scale bar (included in our images). We then navigated to back to the _Image options_ dialogue box to confirm 'OK'. 
6. Semi-landmarks need to be treated like landmarks for curve-fitting. To do this, we used the _Append tps curve to landmarks_ function in _tpsUtil_.
7. Import appended .tps files into R using `from_tps()` function from `Momit` [@bonhomme_2014] or `readmulti.tps()` from `geomorph`. 

&nbsp;

&emsp;&emsp; We used the R package `geomorph` [@adams_2013] to study morphological development (see: "3_geomorph_analysis.R"). First, landmark configurations (shapes) were aligned using a Generalized Procrustes Analysis (see: main text). Aligned landmark configurations (shapes) were then analysed for principal components describing the major axes of shape variation. In `geomorph` this is done using `plotTangentSpace()`. We then fit a linear mixed model to correlate changes in shape with developmental stage:

$$shape = \beta_0 + \beta_1*stage*taxon + U_i + \epsilon$$
&emsp;&emsp; Where $\beta_0$ is the intercept and $\beta_1$ is a coefficient, $U_i$ is the individual-specific random effect, and $\epsilon$ is the residual error. Summary statistics are presented in Table S5. We then visualized the developmental trajectory through shape space for each taxon by implementing `geomorph::trajectory.analysis()` (Figure S3). Pairwise distances of shape means for each stage were calculated in `RRPP` v.0.5.2 [@collyer_2018]. 

&emsp;&emsp; To investigate whether variation in shape can be attributed to curvature, we fit smoothing cubic splines to landmark coordinates for each specimen using `curvature_spline()` from `curvr` v.0.0.1 [@boehm_2021]. This function uses the first and second derivatives of the spline function to estimate total curvature (see: "3_curvature_splines_dorsal.R"). Shapes were pre-aligned so that the distance between landmarks (A) and (B) was parallel with the x-axis. We tested for differences in the development of curvature by fitting a linear model:

$$curvature = \beta_0 + \beta_1*stage*taxon + \epsilon$$ 

&emsp;&emsp; Where $\beta_0$ is the intercept, $\beta_1$ is a coefficient, and $\epsilon$ is the residual error (see: "4_plotting_stage_vs_curv.R"). Because the covariance matrix of the of the random effect was singular (i.e. variance estimate was nearly zero), the variable $U_i$ was omitted (see previous equation). We then tested for pairwise differences of means using `emmeans` as described above. Results are presented in Table S6.

&emsp;&emsp; Finally, we made the qualitative observation that principal component 2 (PC2) of shape space appears to be driven by variation in dorsal curvature of the nectar spur. To test this, we fit the linear mixed effects model in `lmerTest`:

$$PC2 = \beta_0 + \beta_1*curvature + U_i + \epsilon$$
Where $\beta_0$ is the intercept and $\beta_1$ is a coefficient, $U_i$ is the individual-specific random effect, and $\epsilon$ is the residual error (see: "5_ordinations.R"). We measured effect size as $\eta{_p}^2$ (partial eta squared): the ratio of the variance in $PC2$ associated with $curvature$ ($SS_{\kappa}$) to the variance associated with $curvature$ plus its associated variance in error ($SS_{error}$).  



\newpage

#### Circularity, and pairwise comparisons of curvature metrics 

Landmark data was used directly to make the various measurements needed to calculate metrics 2&ndash;5 (see: main text). While `Momocs::coo_scalars()` can be used to obtain most needed measurements (chord length, versine, arc length), we took additional steps to approximate the angle of deflection. For each specimen we determined the coordinates of the shape's centroid. We then used these coordinates to compute a vector from the base of the nectar spur (landmark 1) to the centroid. We computed a second vector, from the base of the spur to the apex (landmark 15). The angle subtending these two vectors was taken as the angle of deflection (Figure S4). 

&emsp;&emsp; To make pairwise comparisons of metrics 2&ndash;5 and total curvature, we generated a correlation matrix using `rcorr()` from `Hmisc` v.4.4-2 [@harrell_2020]. We used Spearman's rank order coefficient ($\rho$) instead of Pearson's $r$ because though we expected several of the metrics to be correlated (see: main text), we did not have an *a priori* reason to expect a linear correlation. 

&emsp;&emsp; To test how circularity affected concordance between total curvature and the _inverse radius_ estimate, we fit the following linear model:

$$1/radius = \beta_0 + \beta_1*curvature + \epsilon$$ 
&emsp;&emsp; Where $radius$ is the value obtained from `pracma::circlefit()`, and $curvature$ is $K_{tot}$ as estimated from `curvr::spline_curvature()`. We then extracted the residuals from this model and regressed against the root mean square error for each fitted circle:

$$|residuals| = \beta_0 + \beta_1*rms*taxon + \epsilon$$ 

&emsp;&emsp; Where $|residuals|$ is the absolute value of the residuals from the previous model, and $rms$ is the root mean square error from each specimen's fitted circle (see: "7_compare_altmetrics.R"). Effect size ($\eta{_p}^2$) was approximated using `effectsize::t_to_eta2()` by extracting the coefficient $t$ value and degrees of freedom from the model summary. 




\newpage

#### Supplementary Figures

&nbsp;
&nbsp;

![Figure S1. Overview of a geometric morphometrics protocol. 1. Landmarks and semi-landmarks are assigned to a specimen. Each landmark is assigned an xy coordinate. 2. For each specimen a configuration of landmarks exists as a single point in a non-Euclidian shape space (abstracted here as a sphere segment). Red points represent landmark configurations from other specimens. 3. Shape data is projected onto a Euclidian plane – a tangent space approximation. This allows statistical analyses of shape variation (e.g. principal components analysis).](Figures/Figure_S1.tif) 


\newpage

![Figure S2. Demonstration that the angle of deflection and inverse radius methods are interchangeable.](Figures/Figure_S2.tif)


\newpage 

![Figure S3: Morphometric trajectory analysis of nectar spur development in *E. koreanum* (circles) and *E. violaceum* (squares). The PC axes and deformation grids illustrate the two most explanatory components of shape change in the development of nectar spurs.](Figures/Figure_S3.tif)

\newpage

![Figure S4. Landmarks (red) and semi-landmarks (white) used to compare curvature between _E. koreanum_ (left) and _E. violaceum_ (right). Landmark (LM) #1 is designated at the apex of the nectar spur. LM #15 is placed at the base of the nectar spur. The blue cross marks the estimated centroid position. The angle subtending the vectors (yellow)  was used as an approximation of the angle of declension. Petals sampled at anthesis.](Figures/Figure_S4.tif)

\newpage

![Figure S5: Total curvature as a function of developmental stage in _Epimedium_.](Figures/Figure_S5.tif) 


\newpage

![Figure S6: Scatterplot of $x$: the error distance for each specimen fitted by a circle - lower values are better approximated by a circle, and $y$: the absolute value of the residual distance between the inverse radius metric and total curvature - greater values for samples where the two metrics disagreed. Green is *E. koreanum*, magenta is *E. violaceum*.](Figures/Figure_S6.tif) 


\newpage

![Figure S7: Comparison of developmental stages and size in _Epimedium_. Tukey's HSD: p<0.01 for all within-species comparisons. Horizontal bars are least-squares means.](Figures/Figure_S7.tif)


\newpage

![Figure S8: Comparison of timing of developmental stages in _Epimedium_. Horizontal bars are least-squares means.](Figures/Figure_S8.tif)


\newpage




#### Supplementary Tables

```{r include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

```

```{r include=FALSE}

library(googlesheets4)

# prevent using auto-token
gs4_deauth()

# sign in
gs4_auth(email = 'mannfredboehm@gmail.com',
         scopes = "https://www.googleapis.com/auth/spreadsheets")

# my "app" info from https://console.cloud.google.com
google_app <- httr::oauth_app(
  appname = "mannys_cool_app",
  key = "1089626906814-9lggcl5o3m7oeaqr583bs23h8pkbdgl7.apps.googleusercontent.com",
  secret = "2uIBhIcqOC85xMx5EWkdQGHG"
)

# my API key
google_key <- gs4_api_key()

# configure access
gs4_auth_configure(app = google_app, api_key = google_key)

```

\newpage

```{r tableS1}
tableS1 <- read_sheet('1KAOTPV3ZJBz4sBDgRnqDuf-22eZOPYasHDGTzTxihVU', col_names=TRUE)

knitr::kable(tableS1, caption = 'Table S1: Additional literature reviewed for metrics of floral or mouthpart curvature outside of plant-pollinator systems.')
```

\newpage

```{r tableS2}

tableS2 <- read_sheet('17_ykDKiimHZWyrgoEZcdls-7gOqH5xyRVa-1XAbKJDM', col_names=TRUE)

knitr::kable(tableS2, caption = 'Table S2: Sample sizes for (A) flowers used to define developmental stages and (B) flowers used to quantify shape variation')
```

\newpage

```{r tableS3}


tableS3 <- read_sheet('1Oz1fDnM0Z-hYzSc3-PgqtCK7m-Cgr2o8Ko1yC1Hacps', col_names=TRUE)

knitr::kable(tableS3, caption = 'Table S3: Stages of _Epimedium_ flower development. EMM is estimated maringal mean, SE is standard error, DF is degrees of freedom.')
```

\newpage

```{r tableS4}


tableS4 <- read_sheet('1sGFhtDE2SUeLwMTHJo93Ym6qUV8C9Uh93hdJkik0XLM', col_names=TRUE)

knitr::kable(tableS4, caption = 'Table S4: Timing of flower development in _Epimedium_. EMM is estimated maringal mean, SE is standard error, DF is degrees of freedom.')
```

\newpage

```{r tableS5}


tableS5 <- read_sheet('17gLOaHuRzZDViyK710uYOu4GuaEpchiMKSHmcfBnaMM', col_names=TRUE)

knitr::kable(tableS5, caption = 'Table S5: Pairwise comparisons of shape through flower development in _Epimedium_. d is standardized (Cohen) effect size, UCL is upper confidence limit, Z is effect size adjusted by standard error. Contrasts are denoted by "Stage, Taxon" where K is _E. koreanum_ and V is _E. violaceum_. Stages (young to old: C,G,T,A)  defined in Table S3. Interspecific contrasts at the same stage are indicate by bold face. The strongest interspecific difference is at the earliest stage (C).')
```

\newpage

```{r tableS6}


tableS6 <- read_sheet('11AJRmuPFN010U5xw3bCE9CwRTT5mdTtJ3ZOTOAAgIsw', col_names=TRUE)

knitr::kable(tableS6, caption = 'Table S6: Estimated means of total curvature through flower development in _Epimedium_. Contrasts are denoted by "Stage, Taxon" where K is _E. koreanum_ and V is _E. violaceum_. Stages (young to old: C,G,T,A) defined in Table S3. Interspecific contrasts at the same stage are indicate by bold face.')
```

\newpage

```{r tableS7}


tableS7 <- read_sheet('1Kety8aS9ktrKXGGGYC4U6b8oh2PqZ2Xr79hdQjC1qj8', col_names=TRUE)

knitr::kable(tableS7, caption = 'Table S7: ANOVA for total curvature and PC2 of shape space. SE is standard error, df is degrees of freedom.')
```

\newpage

```{r tableS8}


tableS8 <- read_sheet('1lFcRF36KnbX5DkkrxKrFdXlar6bu4deeH_hZHdOHEBk', col_names=TRUE)

knitr::kable(tableS8, caption = 'Table S8: Pairwise comparisons between historic metrics and total curvature for _E. violaceum_. Lower diagonal contains Spearman regression coefficients, upper diagonal contains p-values')
```

\newpage

```{r tableS9}


tableS9 <- read_sheet('1Z9bP4EC1AwcOZ-S20OG_Cwqv7VyDbrUS8e4WJgCs9TQ', col_names=TRUE)

knitr::kable(tableS9, caption = 'Table S9: Pairwise comparisons between historic metrics and total curvature for _E. koreanum_. Lower diagonal contains Spearman regression coefficients, upper diagonal contains p-values')
```

# References